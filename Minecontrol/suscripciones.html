<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MineControl | Suscripciones </title>
    
    <link rel="shortcut icon" type="image/x-icon" href="assets/img/AC.ico">     
    <!-- MORRIS CHART STYLES-->
    <link href="assets/js/morris/morris-0.4.3.min.css" rel="stylesheet" />
    <!-- CUSTOM STYLES-->
    <link href="components/common/navbar/navbar.css" rel="stylesheet" type="text/css" />
    <link href="assets/css/custom2.css" rel="stylesheet" />
    <!-- GOOGLE FONTS-->
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css' />
    <!-- BOOTSTRAP STYLES-->
    <link href="assets/css/bootstrap.css" rel="stylesheet" />
     <!-- FONTAWESOME STYLES-->
     <link href="assets/css/font-awesome.css" rel="stylesheet" />
     <style>
        .navbar-cls-top {
            width: 100%;
            position: relative;
            float: left;
        }
        .navbar-side {
            height: 120vh;
            position: relative;
            float: left;
        }
        #page-wrapper {
            width: calc(100% - 260px);
            position: relative;
            float: left;            
        }
    </style>
</head>
<body>
    <div id="wrapper">
        <div hx-trigger="load" hx-get="components/common/navbar/navbarEmpty.html"></div>
        <div id="page-wrapper">
            <div id="page-inner">
                <div class="row">
                    <div class="col-md-12">
                        <h2><b><i>¡Estas a unos pasos de tener tu mina segura!</i></b></h2>
                        <div class="text-center">
                            <h3>Elige el plan que mejor se adapte a tus necesidades</h3>
                        </div>
                        <div class="service-row">
                            <div class="service-box">
                                <i class="bi bi-star-fill service-icon"></i>
                                <h3>Plan mensual</h3> 
                                <p>Accede a todas las funcionalidades de nuestro software durante un mes. Ideal para una evaluación inicial o necesidades temporales en la gestión de tus minas en tiempo real. ¡Pruebalo y conocenos!</p>
                                <h4>Por solo: $400 MX </h4>
                                <div id="paypal-button-container-monthly"></div> <!-- Aquí se integrará el botón de PayPal -->
                            </div>
                            <div class="service-box">
                                <i class="bi bi-cogs service-icon"></i>
                                <h3>Plan semestral</h3>
                                <p>Opta por el plan semestral para una gestión más estable de tus minas, con un ahorro en comparación con el mensual. Perfecto para proyectos de mediana duración y para una supervisión continua.</p>
                                <h4>Por solo: $2200 MX</h4>
                                <div id="paypal-button-container-semester"></div> <!-- Aquí se integrará el botón de PayPal -->
                            </div>
                            <div class="service-box">
                                <i class="bi bi-diamond service-icon"></i>
                                <h3>Plan anual</h3>
                                <p>Elige el plan anual para una gestión completa de tus minas durante todo el año. Obtén el mejor valor y asegúrate una supervisión ininterrumpida con acceso total a todas las funciones del software.</p>
                                <h4>Por solo: $4000 MX</h4>
                                <div id="paypal-button-container-annual"></div> <!-- Aquí se integrará el botón de PayPal -->
                            </div>
                        </div>
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-md-6 col-sm-12 col-xs-12">
                       
                    </div>
                    <div class="col-md-6 col-sm-12 col-xs-12">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                Este pudiera ser tu panel administrativo
                            </div>
                            <div class="panel-body">
                                <ul class="list-group">
                                    <li class="list-group-item">
                                        <span class="badge">!!!</span>
                                        ¡Obten acceso a gráficos que muestran el comportamiento de <br> los sensores en las minas!
                                    </li>
                                    <li class="list-group-item">
                                        <span class="badge">!!!</span>
                                        Información en tiempo real
                                    </li>
                                    <li class="list-group-item">
                                        <span class="badge">!!!</span>
                                        Actualiza tu mina con tecnología de IoT
                                    </li>
                                    <!-- Add more recent activities here -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- JS SCRIPTS-->
    <script src="assets/js/jquery-1.10.2.js"></script>
    <script src="assets/js/bootstrap.min.js"></script>
    <script src="assets/js/jquery.metisMenu.js"></script>
    <script src="assets/js/morris/raphael-2.1.0.min.js"></script>
    <script src="assets/js/morris/morris.js"></script>
    <script src="assets/js/custom2.js"></script>
    <script src="assets/js/updateLink.js"></script>
    <script src="assets/js/admin.js"></script>
    <script src="https://unpkg.com/htmx.org@2.0.1" integrity="sha384-QWGpdj554B4ETpJJC9z+ZHJcA/i59TyjxEPXiiUgN2WmTyV5OEZWCD6gQhgkdpB/" crossorigin="anonymous"></script>
    
    <!-- PayPal Buttons Integration -->
    <script src="https://www.paypal.com/sdk/js?client-id=ASSphX2uduyfMRJLzvh76VXg-iOb7Sjd11zFhJJKVslxLJiH-Zq-zQN9dACdfW-EvM6ix5bX282boVPZ&currency=MXN"></script>
    <script>
   document.addEventListener('DOMContentLoaded', function() {
    setupPaypalButtons();
});

function setupPaypalButtons() {
    // Obtén el userId del localStorage
    const userId = localStorage.getItem('userId');
    console.log('Stored User ID:', userId);

    // Verifica que userId no sea nulo o vacío
    if (!userId) {
        console.error('User ID not found in localStorage');
        return;
    }

    // Botón para el plan mensual
    paypal.Buttons({
        style: {
            color: 'blue',
            shape: 'pill',
            label: 'pay'
        },
        createOrder: function (data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: '400' // El valor debe ser una cadena
                    }
                }]
            });
        },
        onApprove: function (data, actions) {
            return actions.order.capture().then(function (details) {
                // Obtener la fecha actual
                const currentDate = new Date();
                const startDate = currentDate.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                const endDate = new Date(currentDate.setMonth(currentDate.getMonth() + 1)).toISOString().split('T')[0]; // Agregar un mes

                // Datos de suscripción
                const subscriptionData = {
                    tipo: 'Mensual',
                    fecha_inicio: startDate,
                    fecha_fin: endDate,
                    cliente_id: userId, // Usa userId para cliente_id
                    status: 'Activo'
                };

                // Enviar solicitud PUT para actualizar la suscripción usando userId como subscriptionId
                fetch(`http://127.0.0.1:8000/suscripciones/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(subscriptionData)
                })
                .then(response => response.json())
                .then(subscriptionResult => {
                    console.log('Subscription updated:', subscriptionResult);

                    // Datos de pago
                    const paymentData = {
                        fecha_pago: startDate,
                        cantidad: 400,
                        suscripcion_id: userId // Usa userId para suscripcion_id
                    };

                    // Enviar solicitud POST para registrar el pago
                    return fetch('http://127.0.0.1:8000/pagos/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                            // Si necesitas un token de autorización
                        },
                        body: JSON.stringify(paymentData)
                    })
                    .then(response => response.json())
                    .then(paymentResult => {
                        console.log('Payment registered:', paymentResult);
                        window.location.href = `empresa.html?id=${encodeURIComponent(userId)}`;
                    })
                    .catch(error => {
                        console.error('Error registering payment:', error);
                    });
                })
                .catch(error => {
                    console.error('Error updating subscription:', error);
                });
            });
        },
        onCancel: function (data) {
            alert("Pago cancelado");
            console.log(data);
        }
    }).render('#paypal-button-container-monthly');

    // Botón para el plan semestral
    paypal.Buttons({
        style: {
            color: 'blue',
            shape: 'pill',
            label: 'pay'
        },
        createOrder: function (data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: '2200' // El valor debe ser una cadena
                    }
                }]
            });
        },
        onApprove: function (data, actions) {
            return actions.order.capture().then(function (details) {
                // Obtener la fecha actual
                const currentDate = new Date();
                const startDate = currentDate.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                const endDate = new Date(currentDate.setMonth(currentDate.getMonth() + 6)).toISOString().split('T')[0]; // Agregar 6 meses

                // Datos de suscripción
                const subscriptionData = {
                    tipo: 'Semestral',
                    fecha_inicio: startDate,
                    fecha_fin: endDate,
                    cliente_id: userId, // Usa userId para cliente_id
                    status: 'Activo'
                };

                // Enviar solicitud PUT para actualizar la suscripción usando userId como subscriptionId
                fetch(`http://127.0.0.1:8000/suscripciones/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(subscriptionData)
                })
                .then(response => response.json())
                .then(subscriptionResult => {
                    console.log('Subscription updated:', subscriptionResult);

                    // Datos de pago
                    const paymentData = {
                        fecha_pago: startDate,
                        cantidad: 2200,
                        suscripcion_id: userId // Usa userId para suscripcion_id
                    };

                    // Enviar solicitud POST para registrar el pago
                    return fetch('http://127.0.0.1:8000/pagos/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                            // Si necesitas un token de autorización
                        },
                        body: JSON.stringify(paymentData)
                    })
                    .then(response => response.json())
                    .then(paymentResult => {
                        console.log('Payment registered:', paymentResult);
                        window.location.href = `empresa.html?id=${encodeURIComponent(userId)}`;
                    })
                    .catch(error => {
                        console.error('Error registering payment:', error);
                    });
                })
                .catch(error => {
                    console.error('Error updating subscription:', error);
                });
            });
        },
        onCancel: function (data) {
            alert("Pago cancelado");
            console.log(data);
        }
    }).render('#paypal-button-container-semester');

    // Botón para el plan anual
    paypal.Buttons({
        style: {
            color: 'blue',
            shape: 'pill',
            label: 'pay'
        },
        createOrder: function (data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: '4000' // El valor debe ser una cadena
                    }
                }]
            });
        },
        
        onApprove: function (data, actions) {
            return actions.order.capture().then(function (details) {
                // Obtener la fecha actual
                const currentDate = new Date();
                const startDate = currentDate.toISOString().split('T')[0]; // Formato YYYY-MM-DD
                const endDate = new Date(currentDate.setFullYear(currentDate.getFullYear() + 1)).toISOString().split('T')[0]; // Agregar 1 año

                // Datos de suscripción
                const subscriptionData = {
                    tipo: 'Anual',
                    fecha_inicio: startDate,
                    fecha_fin: endDate,
                    cliente_id: userId, // Usa userId para cliente_id
                    status: 'Activo'
                };

                // Enviar solicitud PUT para actualizar la suscripción usando userId como subscriptionId
                fetch(`http://127.0.0.1:8000/suscripciones/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(subscriptionData)
                })
                .then(response => response.json())
                .then(subscriptionResult => {
                    console.log('Subscription updated:', subscriptionResult);

                    // Datos de pago
                    const paymentData = {
                        fecha_pago: startDate,
                        cantidad: 4000,
                        suscripcion_id: userId // Usa userId para suscripcion_id
                    };

                    // Enviar solicitud POST para registrar el pago
                    return fetch('http://127.0.0.1:8000/pagos/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                            // Si necesitas un token de autorización
                        },
                        body: JSON.stringify(paymentData)
                    })
                    .then(response => response.json())
                    .then(paymentResult => {
                        console.log('Payment registered:', paymentResult);
                        window.location.href = `empresa.html?id=${encodeURIComponent(userId)}`;
                    })
                    .catch(error => {
                        console.error('Error registering payment:', error);
                    });
                })
                .catch(error => {
                    console.error('Error updating subscription:', error);
                });
            });
        },
        onCancel: function (data) {
            alert("Pago cancelado");
            console.log(data);
        }
    }).render('#paypal-button-container-annual');
}


    </script>
</body>
</html>